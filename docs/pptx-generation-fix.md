# PPTX Generation Fix - Path Resolution Issue

## Vấn đề

Khi click "Download PPTX" trong CreateSlideSplitView, gặp lỗi:
```
ERROR  Error generating PPTX: ENOENT: no such file or directory,
open '/output/a40823fa-4a57-45b5-a669-b2295e392927_content.json'
```

## Nguyên nhân

API `/api/pptx/generate` expect parameter `contentPath` phải là **absolute path** trên filesystem.

Frontend đang pass **relative path** sai:
```javascript
contentPath: `/output/${selectedJobId.value}_content.json`
// Path này bắt đầu với "/" nên OS hiểu là root directory
// Thực tế path đúng phải là: /home/tamht91/Projects/migrate-to-nodejs/output/...
```

## Giải pháp

Đơn giản hóa API - chỉ cần `jobId`, API tự build absolute path.

### 1. Backend Fix: `/server/api/pptx/generate.post.ts`

**Trước:**
```typescript
const body = await readBody(event);
const { jobId, contentPath } = body;

if (!jobId || !contentPath) {
  throw createError({
    statusCode: 400,
    message: 'jobId and contentPath are required'
  });
}

const contentData = await readFile(contentPath, 'utf-8');
```

**Sau:**
```typescript
const body = await readBody(event);
const { jobId } = body;

if (!jobId) {
  throw createError({
    statusCode: 400,
    message: 'jobId is required'
  });
}

// Build content file path
const outputDir = join(process.cwd(), 'output');
const contentPath = join(outputDir, `${jobId}_content.json`);

const contentData = await readFile(contentPath, 'utf-8');
```

### 2. Frontend Fix: CreateSlideSplitView.vue

**Trước:**
```javascript
const response = await $fetch('/api/pptx/generate', {
  method: 'POST',
  body: {
    jobId: selectedJobId.value,
    contentPath: `/output/${selectedJobId.value}_content.json`  // ❌ Wrong path
  }
});
```

**Sau:**
```javascript
const response = await $fetch('/api/pptx/generate', {
  method: 'POST',
  body: {
    jobId: selectedJobId.value  // ✅ Only jobId needed
  }
});
```

### 3. Validation: Check slides generated

Thêm validation để ensure user đã generate ít nhất 1 slide:

```javascript
const downloadPPTX = async () => {
  // Check if any slides are generated
  if (generatedSlides.value.size === 0) {
    alert('Please generate at least one slide before downloading.');
    return;
  }

  // ... rest of code
};
```

### 4. Update Old Component: CreateSlideTab.vue

Để consistency, update old component cũng dùng API mới:

**Trước:**
```javascript
const pptxResponse = await $fetch('/api/pptx/generate', {
  method: 'POST',
  body: {
    jobId: selectedJobId.value,
    contentPath: contentResponse.contentPath  // ❌ No longer needed
  }
});
```

**Sau:**
```javascript
const pptxResponse = await $fetch('/api/pptx/generate', {
  method: 'POST',
  body: {
    jobId: selectedJobId.value  // ✅ Simpler
  }
});
```

## Benefits

1. **Simpler API**: Chỉ cần jobId thay vì jobId + contentPath
2. **Safer**: Backend control file path, không tin tưởng frontend input
3. **Consistent**: API tự build path theo convention (`output/{jobId}_content.json`)
4. **Less error-prone**: Không có path resolution issues

## File Structure Convention

```
project_root/
├── output/
│   ├── {jobId}_content.json    ← Content generated by AI
│   └── {jobId}.pptx             ← Final PPTX file
└── structure/
    └── {jobId}.json             ← Slide structure
```

## API Contract (Updated)

### POST /api/pptx/generate

**Request:**
```json
{
  "jobId": "a40823fa-4a57-45b5-a669-b2295e392927"
}
```

**Response:**
```json
{
  "success": true,
  "pptxPath": "/home/tamht91/Projects/migrate-to-nodejs/output/a40823fa-...-b2295e392927.pptx"
}
```

**Error:**
```json
{
  "statusCode": 404,
  "message": "ENOENT: no such file or directory, open '.../_content.json'"
}
```

**Note:** Nếu content file chưa tồn tại, user cần:
1. Generate slides trước (using "Regenerate" buttons)
2. Hoặc click "Generate All" để generate tất cả slides

## Testing Steps

1. **Select một job** từ dropdown
2. **Generate slides:**
   - Option A: Click "Regenerate" trên từng slide
   - Option B: Click "Generate All" để generate tất cả
3. **Verify slides có status ✓** (generated)
4. **Click "Download PPTX"**
5. **PPTX file should download** successfully

## Related Files Modified

- ✅ `server/api/pptx/generate.post.ts` - API simplified
- ✅ `components/CreateSlideSplitView.vue` - Remove contentPath param, add validation
- ✅ `components/CreateSlideTab.vue` - Update for consistency

---

**Fixed Date:** 2026-01-20
**Status:** ✅ Complete and tested